# Eight_IR_OLED 项目改进说明

## 改进概述
根据比赛任务要求（task.md），对智能小车循线系统进行了以下优化，以减少比赛时间惩罚并增加加分项。

## 完成的功能改进

### 1. ✅ 按键启动功能 (避免+5秒惩罚)
- **实现位置**: `main.c` 
- **功能描述**: 
  - 增加了系统状态机，包含三个状态：等待启动(STATE_WAIT_START)、运行中(STATE_RUNNING)、已完成(STATE_FINISHED)
  - 小车启动前需要按下按键，防止误启动
  - 按键采用消抖处理，确保可靠触发
- **时间收益**: 避免+5秒惩罚

### 2. ✅ 蜂鸣器计数响应 (避免每个点位+5秒惩罚)
- **实现位置**: `main.c` - `Check_Wide_Line()`函数
- **功能描述**:
  - 通过8路红外传感器检测20cm宽的白线标记点
  - 自动识别蜂鸣器响应点(B点位)
  - 第一个B点响1次，第二个B点响2次，第三个B点响3次，第四个B点响4次
  - 响声间隔150ms，确保有明确区分度
- **检测逻辑**: 当至少6个传感器检测到白线时判定为宽线
- **时间收益**: 避免4个点位×5秒=20秒惩罚

### 3. ✅ OLED时间显示 (减少20秒)
- **实现位置**: 
  - `main.c` - `Display_Time()`函数
  - `bsp_timer.c` - 定时器中断
- **功能描述**:
  - 在20ms定时器中断中累计运行时间
  - 精确到0.01秒(厘秒)显示
  - 显示格式: "Time: XXX.XX s"
  - 同时显示当前经过的蜂鸣器点位数
- **时间收益**: -20秒

### 4. ✅ 终点自动停车 (避免+10秒惩罚)
- **实现位置**: `main.c` - `Check_Wide_Line()`函数
- **功能描述**:
  - 检测到第5个宽线（终点D）时自动切换到STATE_FINISHED状态
  - 调用`Motion_Ctrl(0, 0, 0)`停止电机
  - 蜂鸣器响2次作为完成提示
  - 显示"FINISHED!"信息
- **时间收益**: 避免+10秒惩罚

### 5. ✅ RGB彩灯效果 (减少5秒)
- **实现位置**: `main.c` - `RGB_Running_Effect()`函数
- **功能描述**:
  - 实现RGB跑马灯效果，循环显示6种颜色
  - 颜色顺序: 红色→绿色→蓝色→黄色→紫色→青色
  - 如果项目未配置RGB硬件，代码会自动跳过
- **时间收益**: -5秒

### 6. ⚠️ 干扰线处理 (C点位)
- **实现位置**: 保持原有`app_irtracking_eight.c`的巡线逻辑
- **功能描述**:
  - 使用8路红外传感器的PID控制算法
  - 能够处理宽度为10cm的干扰线（一边3cm，一边6cm）
  - 间隔10cm的干扰线不会影响正常循线
- **说明**: 现有的巡线算法已经能够应对干扰线，无需额外修改

## 预期时间效益总结

| 项目 | 时间变化 | 状态 |
|------|---------|------|
| 按键启动 | 避免+5秒 | ✅ 已实现 |
| 蜂鸣器响应(4个点位) | 避免+20秒 | ✅ 已实现 |
| 终点停车 | 避免+10秒 | ✅ 已实现 |
| OLED时间显示 | -20秒 | ✅ 已实现 |
| RGB彩灯 | -5秒 | ✅ 已实现 |
| **总计** | **最多减少60秒** | **已完成** |

## 技术要点

### 宽线检测算法
- 使用8路红外传感器阵列
- 检测逻辑：至少6个传感器同时检测到白线
- 防抖设计：使用`wide_line_hold`计数器，防止重复触发
- 状态记忆：`is_on_wide_line`标志位确保每个宽线只触发一次

### 状态机设计
```
STATE_WAIT_START (等待按键) 
    ↓ (按键按下)
STATE_RUNNING (循线运行)
    ↓ (检测到终点)
STATE_FINISHED (停车完成)
```

### 时间计数
- 基于20ms定时器中断
- 仅在STATE_RUNNING状态累计时间
- 精度：20ms (可显示为0.01秒单位)

## 硬件配置要求

### 必需硬件
1. MSPM0 MCU
2. 8路红外循迹传感器
3. OLED显示屏 (I2C接口)
4. 蜂鸣器
5. 按键 (建议使用PA18引脚，上拉配置)
6. 直流电机驱动

### 可选硬件
1. WS2812B RGB灯珠 (用于-5秒加分项)

## 使用说明

### 启动流程
1. 上电后，OLED显示 "Press KEY Start"
2. 将小车放置在起点A的红线位置
3. 按下按键，听到1声蜂鸣器提示音
4. 小车开始运行，OLED显示实时时间和蜂鸣器计数
5. 经过B点位时自动响应相应次数
6. 到达终点D时自动停车，听到2声提示音

### 调试建议
1. 首先测试按键功能和OLED显示
2. 单独测试蜂鸣器响应逻辑
3. 在赛道上测试宽线检测灵敏度
4. 根据实际情况调整`white_count >= 6`的阈值
5. 微调PID参数以优化循线性能

## 注意事项

1. **按键引脚配置**: 代码中使用PA18作为按键引脚，需要在`ti_msp_dl_config.h`中正确配置为GPIO输入、上拉模式
2. **传感器校准**: 确保8路红外传感器已校准，黑线返回0，白线返回1
3. **定时器配置**: 确保20ms定时器已在syscfg中正确配置并使能中断
4. **RGB可选**: 如果没有RGB灯珠，代码会通过预编译指令跳过RGB功能
5. **比赛前测试**: 务必在实际赛道上多次测试，确保所有功能正常工作

## 后续优化建议

1. **速度优化**: 可以根据赛道特点调整`IRR_SPEED`参数
2. **传感器阈值**: 根据环境光照条件调整白线检测阈值
3. **急转弯处理**: 针对90度转弯增强转向控制
4. **故障恢复**: 增加脱轨检测和自动恢复逻辑
5. **数据记录**: 可以通过串口输出详细的运行数据用于分析

## 文件修改清单

- ✏️ `main.c` - 主要改动文件
- ✏️ `bsp_timer.c` - 添加时间累计功能
- 📄 `IMPROVEMENTS.md` - 本文档

---
**版本**: v1.0  
**日期**: 2025年12月16日  
**状态**: 已完成核心功能实现
